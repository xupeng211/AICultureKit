name: AICultureKit Gate
on:
  pull_request:
    branches: [ main ]
  push:
    branches: [ main ]

jobs:
  gate:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
    - name: ğŸš€ Checkoutä»£ç 
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # è·å–å®Œæ•´å†å²ï¼Œç”¨äºdiff-cover
    
    - name: ğŸ è®¾ç½®Pythonç¯å¢ƒ
      uses: actions/setup-python@v5
      with:
        python-version: "3.11"
        cache: 'pip'
    
    - name: ğŸ“¦ å®‰è£…ä¾èµ–
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt || echo "requirements.txtä¸å­˜åœ¨ï¼Œè·³è¿‡"
        pip install pre-commit diff-cover coverage pytest ruff black isort bandit detect-secrets pytest-cov
    
    - name: ğŸ“ ä»£ç é£æ ¼æ£€æŸ¥
      run: |
        echo "ğŸ” è¿è¡Œä»£ç é£æ ¼æ£€æŸ¥..."
        mkdir -p artifacts
        python -m ruff check . --output-format=json > artifacts/ruff_report.json || true
        python -m ruff check . || echo "âš ï¸ Ruffå‘ç°é—®é¢˜ï¼Œä½†ä¸é˜»å¡CI"
        python -m black --check --diff . || echo "âš ï¸ Blackå‘ç°æ ¼å¼é—®é¢˜ï¼Œä½†ä¸é˜»å¡CI"
        python -m isort --check-only --diff . || echo "âš ï¸ isortå‘ç°é—®é¢˜ï¼Œä½†ä¸é˜»å¡CI"
      continue-on-error: true
    
    - name: ğŸ§ª è¿è¡Œæµ‹è¯•
      run: |
        echo "ğŸ§ª è¿è¡Œæµ‹è¯•å¥—ä»¶..."
        pytest -q --maxfail=5 --disable-warnings --tb=short || echo "âš ï¸ éƒ¨åˆ†æµ‹è¯•å¤±è´¥ï¼Œä½†ç»§ç»­æ‰§è¡Œ"
        pytest -q --maxfail=1 --disable-warnings --cov=aiculture --cov=tools --cov-report=xml:coverage.xml --cov-report=term-missing || echo "âš ï¸ è¦†ç›–ç‡æµ‹è¯•å¤±è´¥"
      continue-on-error: true
    
    - name: ğŸ“Š å¢é‡è¦†ç›–ç‡æ£€æŸ¥
      run: |
        echo "ğŸ“Š è¿è¡Œå¢é‡è¦†ç›–ç‡æ£€æŸ¥..."
        if [ -f "coverage.xml" ]; then
          echo "å‘ç°è¦†ç›–ç‡æŠ¥å‘Šï¼Œæ‰§è¡Œdiff-coveræ£€æŸ¥..."
          diff-cover coverage.xml --compare-branch=origin/main --fail-under=80 --json-report=artifacts/diff_coverage.json || echo "âš ï¸ å¢é‡è¦†ç›–ç‡ä¸è¾¾æ ‡"
          diff-cover coverage.xml --compare-branch=origin/main --html-report=artifacts/diff_coverage.html || true
          echo "ğŸ“‹ è¦†ç›–ç‡æŠ¥å‘Šå·²ç”Ÿæˆ"
        else
          echo "âš ï¸ æœªæ‰¾åˆ°è¦†ç›–ç‡æŠ¥å‘Šï¼Œè·³è¿‡å¢é‡è¦†ç›–ç‡æ£€æŸ¥"
        fi
      continue-on-error: true
    
    - name: ğŸ”’ å®‰å…¨æ£€æŸ¥
      run: |
        echo "ğŸ”’ è¿è¡Œå®‰å…¨æ£€æŸ¥..."
        bandit -r . -f json -o artifacts/bandit_report.json || echo "âš ï¸ Banditå‘ç°å®‰å…¨é—®é¢˜"
        bandit -r . || echo "âš ï¸ å®‰å…¨æ£€æŸ¥å‘ç°é—®é¢˜ï¼Œä½†ä¸é˜»å¡CI"
        detect-secrets scan --all-files --baseline .secrets.baseline || echo "âš ï¸ å‘ç°æ½œåœ¨å¯†é’¥æ³„æ¼"
      continue-on-error: true
    
    - name: ğŸ“‹ ç”ŸæˆAICultureKitæŠ¥å‘Š
      run: |
        echo "ğŸ“‹ ç”ŸæˆAICultureKitç»¼åˆè´¨é‡æŠ¥å‘Š..."
        if [ -d "tools/problem_aggregator" ]; then
          echo "ğŸ” è¿è¡ŒAICultureKité—®é¢˜èšåˆå™¨..."
          python -m tools.problem_aggregator.aggregator --base origin/main --out artifacts/ci_problems.json --md artifacts/ci_problems_report.md || echo "âš ï¸ é—®é¢˜èšåˆå™¨æ‰§è¡Œå¤±è´¥"
          
          # å¦‚æœæœ‰é—®é¢˜ï¼Œå°è¯•ç”ŸæˆAIä¿®å¤å»ºè®®
          if [ -f "artifacts/ci_problems.json" ]; then
            echo "ğŸ¤– å°è¯•ç”ŸæˆAIä¿®å¤å»ºè®®..."
            python -m tools.ai_fix_agent.agent --in artifacts/ci_problems.json --out artifacts/ai_fixes || echo "âš ï¸ AIä¿®å¤å»ºè®®ç”Ÿæˆå¤±è´¥"
          fi
        else
          echo "âš ï¸ æœªæ‰¾åˆ°é—®é¢˜èšåˆå™¨ï¼Œè·³è¿‡"
        fi
      continue-on-error: true
    
    - name: ğŸšª Gateå†³ç­–
      run: |
        echo "ğŸšª AICultureKit Gate æœ€ç»ˆå†³ç­–..."
        
        # æ£€æŸ¥æ˜¯å¦æœ‰é˜»å¡æ€§é—®é¢˜
        BLOCKING_ISSUES=0
        
        if [ -f "artifacts/ci_problems.json" ]; then
          # ä½¿ç”¨Pythonè§£æJSONè·å–é˜»å¡æ€§é—®é¢˜æ•°é‡
          BLOCKING_ISSUES=$(python -c "
import json
try:
    with open('artifacts/ci_problems.json', 'r') as f:
        data = json.load(f)
    print(data.get('summary', {}).get('blocking', 0))
except:
    print(0)
" 2>/dev/null || echo 0)
          
          echo "å‘ç° $BLOCKING_ISSUES ä¸ªé˜»å¡æ€§é—®é¢˜"
        fi
        
        # ç”ŸæˆCIæ‘˜è¦
        echo "# ğŸ” AICultureKit CI Gate æŠ¥å‘Š" > artifacts/ci_summary.md
        echo "" >> artifacts/ci_summary.md
        echo "**æ„å»ºæ—¶é—´**: $(date)" >> artifacts/ci_summary.md
        echo "**åˆ†æ”¯**: ${{ github.ref_name }}" >> artifacts/ci_summary.md
        echo "**æäº¤**: ${{ github.sha }}" >> artifacts/ci_summary.md
        echo "**PR**: ${{ github.event.number }}" >> artifacts/ci_summary.md
        echo "" >> artifacts/ci_summary.md
        echo "## ğŸ“Š æ£€æŸ¥ç»“æœ" >> artifacts/ci_summary.md
        echo "" >> artifacts/ci_summary.md
        echo "- **ä»£ç é£æ ¼**: $([ -f artifacts/ruff_report.json ] && echo 'âœ… å·²æ£€æŸ¥' || echo 'âŒ æœªæ‰§è¡Œ')" >> artifacts/ci_summary.md
        echo "- **æµ‹è¯•æ‰§è¡Œ**: $([ -f coverage.xml ] && echo 'âœ… å·²æ‰§è¡Œ' || echo 'âŒ æœªæ‰§è¡Œ')" >> artifacts/ci_summary.md
        echo "- **å¢é‡è¦†ç›–ç‡**: $([ -f artifacts/diff_coverage.json ] && echo 'âœ… å·²æ£€æŸ¥' || echo 'âŒ æœªæ‰§è¡Œ')" >> artifacts/ci_summary.md
        echo "- **å®‰å…¨æ£€æŸ¥**: $([ -f artifacts/bandit_report.json ] && echo 'âœ… å·²æ£€æŸ¥' || echo 'âŒ æœªæ‰§è¡Œ')" >> artifacts/ci_summary.md
        echo "- **é—®é¢˜èšåˆ**: $([ -f artifacts/ci_problems.json ] && echo 'âœ… å·²ç”Ÿæˆ' || echo 'âŒ æœªç”Ÿæˆ')" >> artifacts/ci_summary.md
        echo "- **é˜»å¡æ€§é—®é¢˜**: $BLOCKING_ISSUES ä¸ª" >> artifacts/ci_summary.md
        echo "" >> artifacts/ci_summary.md
        
        if [ "$BLOCKING_ISSUES" -gt 0 ]; then
          echo "## âŒ PRåˆå¹¶è¢«é˜»å¡" >> artifacts/ci_summary.md
          echo "" >> artifacts/ci_summary.md
          echo "å­˜åœ¨ $BLOCKING_ISSUES ä¸ªé˜»å¡æ€§é—®é¢˜éœ€è¦ä¿®å¤" >> artifacts/ci_summary.md
          echo "" >> artifacts/ci_summary.md
          echo "### ğŸš€ ä¿®å¤æ­¥éª¤" >> artifacts/ci_summary.md
          echo "1. ä¸‹è½½CI artifactsæŸ¥çœ‹è¯¦ç»†æŠ¥å‘Š" >> artifacts/ci_summary.md
          echo "2. æŸ¥çœ‹ \`artifacts/ci_problems_report.md\` äº†è§£é—®é¢˜è¯¦æƒ…" >> artifacts/ci_summary.md
          echo "3. åº”ç”¨AIä¿®å¤å»ºè®®: \`cd artifacts/ai_fixes && ./apply_fixes.sh\`" >> artifacts/ci_summary.md
          echo "4. æœ¬åœ°éªŒè¯: \`python -m tools.problem_aggregator.aggregator\`" >> artifacts/ci_summary.md
          echo "5. ä¿®å¤å®Œæˆåé‡æ–°æ¨é€" >> artifacts/ci_summary.md
        else
          echo "## âœ… æ‰€æœ‰æ£€æŸ¥é€šè¿‡" >> artifacts/ci_summary.md
          echo "" >> artifacts/ci_summary.md
          echo "PRå¯ä»¥å®‰å…¨åˆå¹¶" >> artifacts/ci_summary.md
        fi
        
        # ä»…åœ¨PRæ—¶é˜»å¡
        if [ "${{ github.event_name }}" = "pull_request" ] && [ "$BLOCKING_ISSUES" -gt 0 ]; then
          echo "âŒ PRåˆå¹¶è¢«é˜»å¡: å­˜åœ¨ $BLOCKING_ISSUES ä¸ªé˜»å¡æ€§é—®é¢˜"
          echo "ğŸ“‹ è¯¦ç»†æŠ¥å‘Šå°†åœ¨CI artifactsä¸­æä¾›"
          exit 1
        else
          echo "âœ… Gateæ£€æŸ¥å®Œæˆ"
          exit 0
        fi
    
    - name: ğŸ“¤ ä¸Šä¼ æŠ¥å‘Š
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: aiculturekit-reports
        path: artifacts/
        retention-days: 7
    
    - name: ğŸ’¬ PRè¯„è®º
      uses: actions/github-script@v7
      if: github.event_name == 'pull_request' && always()
      with:
        script: |
          const fs = require('fs');
          
          let comment = '## ğŸ” AICultureKit CI Gate æŠ¥å‘Š\n\n';
          
          try {
            if (fs.existsSync('artifacts/ci_summary.md')) {
              const summary = fs.readFileSync('artifacts/ci_summary.md', 'utf8');
              comment += summary;
            } else {
              comment += 'âš ï¸ æœªèƒ½ç”Ÿæˆè¯¦ç»†æŠ¥å‘Šï¼Œè¯·æŸ¥çœ‹CIæ—¥å¿—\n';
            }
          } catch (error) {
            comment += `âŒ è¯»å–æŠ¥å‘Šå¤±è´¥: ${error.message}\n`;
          }
          
          comment += '\n---\n';
          comment += `ğŸ¤– ç”± AICultureKit è‡ªåŠ¨ç”Ÿæˆ | æ„å»º: ${context.runId}`;
          
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: comment
          });
