name: ğŸš€ AICultureKit Quality Gate

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  schedule:
    # æ¯å¤©å‡Œæ™¨2ç‚¹è¿è¡Œå®Œæ•´æ£€æŸ¥
    - cron: '0 2 * * *'

env:
  PYTHON_VERSION: '3.11'
  COVERAGE_THRESHOLD: 30

jobs:
  # ğŸ§ª å¿«é€Ÿè´¨é‡æ£€æŸ¥
  quick-check:
    name: ğŸš€ å¿«é€Ÿè´¨é‡æ£€æŸ¥
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
    - name: ğŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: ğŸ è®¾ç½®Pythonç¯å¢ƒ
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'
        
    - name: ğŸ“¦ å®‰è£…ä¾èµ–
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install -r requirements-dev.txt
        
    - name: ğŸ¨ ä»£ç æ ¼å¼åŒ–æ£€æŸ¥
      run: |
        black --check --diff .
        isort --check-only --diff .
        
    - name: ğŸ” ä»£ç è´¨é‡æ£€æŸ¥
      run: |
        flake8 . || true  # ä¸é˜»å¡ï¼Œä»…è­¦å‘Š
        
    - name: ğŸ§ª å¿«é€Ÿæµ‹è¯•
      run: |
        pytest tests/ -x --tb=short -q

  # ğŸ”¬ å®Œæ•´è´¨é‡æ£€æŸ¥
  full-check:
    name: ğŸ”¬ å®Œæ•´è´¨é‡æ£€æŸ¥
    runs-on: ubuntu-latest
    needs: quick-check
    timeout-minutes: 20
    
    steps:
    - name: ğŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: ğŸ è®¾ç½®Pythonç¯å¢ƒ
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'
        
    - name: ğŸ“¦ å®‰è£…ä¾èµ–
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install -r requirements-dev.txt
        
    - name: ğŸ§ª è¿è¡Œå®Œæ•´æµ‹è¯•å¥—ä»¶
      run: |
        pytest --cov=aiculture --cov-report=xml --cov-report=term-missing
        
    - name: ğŸ“Š ä¸Šä¼ è¦†ç›–ç‡æŠ¥å‘Š
      uses: codecov/codecov-action@v5
      with:
        file: ./coverage.xml
        flags: unittests
        name: codecov-umbrella
        
    - name: ğŸ”§ ç±»å‹æ£€æŸ¥
      run: |
        mypy aiculture --ignore-missing-imports || true
        
    - name: ğŸ”’ å®‰å…¨æ£€æŸ¥
      run: |
        bandit -r aiculture -f json -o bandit-report.json || true
        
    - name: ğŸ“‹ ç”Ÿæˆè´¨é‡æŠ¥å‘Š
      run: |
        python scripts/generate_quality_report.py
        
    - name: ğŸ“¤ ä¸Šä¼ è´¨é‡æŠ¥å‘Š
      uses: actions/upload-artifact@v3
      with:
        name: quality-report
        path: quality-report.html

  # ğŸŒ å¤šç¯å¢ƒæµ‹è¯•
  multi-env-test:
    name: ğŸŒ å¤šç¯å¢ƒæµ‹è¯•
    runs-on: ${{ matrix.os }}
    needs: quick-check
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        python-version: ['3.9', '3.10', '3.11']
        exclude:
          # å‡å°‘çŸ©é˜µå¤§å°ï¼Œåªåœ¨Ubuntuä¸Šæµ‹è¯•æ‰€æœ‰Pythonç‰ˆæœ¬
          - os: windows-latest
            python-version: '3.9'
          - os: macos-latest
            python-version: '3.9'
    
    steps:
    - name: ğŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: ğŸ è®¾ç½®Python ${{ matrix.python-version }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}
        cache: 'pip'
        
    - name: ğŸ“¦ å®‰è£…ä¾èµ–
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pytest
        
    - name: ğŸ§ª è¿è¡Œæ ¸å¿ƒæµ‹è¯•
      run: |
        pytest tests/test_core.py tests/test_culture_enforcer.py -v

  # ğŸš€ è‡ªåŠ¨ä¿®å¤å’ŒPR
  auto-fix:
    name: ğŸš€ è‡ªåŠ¨ä¿®å¤ä»£ç é—®é¢˜
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/develop'
    
    steps:
    - name: ğŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        
    - name: ğŸ è®¾ç½®Pythonç¯å¢ƒ
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        
    - name: ğŸ“¦ å®‰è£…å·¥å…·
      run: |
        pip install black isort autoflake
        
    - name: ğŸ”§ è‡ªåŠ¨ä¿®å¤ä»£ç 
      run: |
        black .
        isort .
        autoflake --in-place --remove-all-unused-imports --recursive .
        
    - name: ğŸ“ æäº¤ä¿®å¤
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add .
        if ! git diff --cached --quiet; then
          git commit -m "ğŸ¤– è‡ªåŠ¨ä¿®å¤ä»£ç æ ¼å¼å’Œå¯¼å…¥é—®é¢˜"
          git push
        fi

  # ğŸ“¦ è‡ªåŠ¨å‘å¸ƒ
  auto-release:
    name: ğŸ“¦ è‡ªåŠ¨å‘å¸ƒ
    runs-on: ubuntu-latest
    needs: [full-check, multi-env-test]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'

    steps:
    - name: ğŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: ğŸ è®¾ç½®Pythonç¯å¢ƒ
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    - name: ğŸ“¦ å®‰è£…æ„å»ºå·¥å…·
      run: |
        pip install build twine

    - name: ğŸ—ï¸ æ„å»ºåŒ…
      run: |
        python -m build

    - name: ğŸ§ª æ£€æŸ¥åŒ…
      run: |
        twine check dist/*

    - name: ğŸ“¤ å‘å¸ƒåˆ°TestPyPI
      if: contains(github.event.head_commit.message, '[release]')
      env:
        TWINE_USERNAME: __token__
        TWINE_PASSWORD: ${{ secrets.TEST_PYPI_API_TOKEN }}
      run: |
        twine upload --repository testpypi dist/*

  # ğŸ“Š è´¨é‡è¶‹åŠ¿åˆ†æ
  quality-trend:
    name: ğŸ“Š è´¨é‡è¶‹åŠ¿åˆ†æ
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule'

    steps:
    - name: ğŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: ğŸ è®¾ç½®Pythonç¯å¢ƒ
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    - name: ğŸ“¦ å®‰è£…ä¾èµ–
      run: |
        pip install -r requirements.txt
        pip install -r requirements-dev.txt

    - name: ğŸ“ˆ ç”Ÿæˆè¶‹åŠ¿æŠ¥å‘Š
      run: |
        python scripts/generate_trend_report.py

    - name: ğŸ“¤ ä¸Šä¼ è¶‹åŠ¿æŠ¥å‘Š
      uses: actions/upload-artifact@v3
      with:
        name: quality-trend-report
        path: trend-report.html
