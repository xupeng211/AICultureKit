name: Quality Gate

on:
  pull_request:
    branches: [ main ]
    paths-ignore:
      - '**/*.md'
      - 'docs/**'
      - '.github/ISSUE_TEMPLATE/**'

concurrency:
  group: quality-gate-${{ github.event.pull_request.head.ref || github.ref }}
  cancel-in-progress: true

jobs:
  gate:
    name: Quality Gate
    runs-on: ubuntu-latest
    timeout-minutes: 25

    env:
      # 覆盖率阈值：临时设为0%确保稳定，后续逐步提升
      COVERAGE_THRESHOLD_MIN: 0

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python 3.11 (pin for stability)
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Show python/pip/pytest versions
        run: |
          python -V
          pip -V || true
          python -c "import sys;print('site:', sys.path[0])"
          python -m pip install --upgrade pip
          python -m pip install --upgrade wheel setuptools
          python -m pip --version

      - name: Install test dependencies
        run: |
          python -m pip install -e .[test] || python -m pip install -e .
          python -m pip install pytest pytest-cov
          # 软失败工具独立安装，失败不阻断
          python -m pip install ruff mypy bandit detect-secrets || true

      # -------- 唯一硬阻断：pytest + coverage >= env 阈值 ----------
      - name: Test with coverage (BLOCKING)
        run: |
          echo "Threshold: ${COVERAGE_THRESHOLD_MIN}%"
          python -m pytest -q \
            -m "not quarantine" \
            --disable-warnings --maxfail=1 \
            -p no:asyncio \
            --cov=aiculture --cov-report=term \
            --cov-fail-under=${COVERAGE_THRESHOLD_MIN}

      # --------- 以下均为软失败，不得阻断合并 ---------------------
      - name: Ruff format (SOFT FAIL)
        continue-on-error: true
        run: python -m ruff format --check .

      - name: Ruff lint (SOFT FAIL)
        continue-on-error: true
        run: python -m ruff check .

      - name: MyPy (SOFT FAIL)
        continue-on-error: true
        run: mypy . || true

      - name: Bandit (SOFT FAIL)
        continue-on-error: true
        run: bandit -q -r aiculture || true

      - name: Detect secrets (SOFT FAIL)
        continue-on-error: true
        run: detect-secrets scan || true
