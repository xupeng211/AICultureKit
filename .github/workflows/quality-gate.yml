name: Quality Gate

on:
  pull_request:
    branches: [ main ]
    types: [opened, synchronize, reopened]

concurrency:
  group: quality-gate-${{ github.ref }}
  cancel-in-progress: true

jobs:
  gate:
    name: Quality Gate
    runs-on: ubuntu-latest
    timeout-minutes: 25

    env:
      COVERAGE_THRESHOLD_MIN: 12

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Show versions
        run: |
          python -V
          pip -V

      - name: Install project with test deps
        run: |
          python -m pip install -U pip
          pip install -e .[dev] || pip install -e .
          pip install pytest pytest-cov

      # ✅ 唯一阻断项：pytest + coverage
      - name: Test with coverage (BLOCKING)
        run: |
          python -m pytest -q \
            --disable-warnings --maxfail=1 \
            -p no:asyncio \
            --cov=aiculture --cov-report=term-missing \
            --cov-fail-under=${COVERAGE_THRESHOLD_MIN}

      # 其余全部软失败（不阻断）
      - name: Ruff format (SOFT)
        run: |
          python -m pip install ruff==0.5.7
          python -m ruff format --check . || true
      - name: Ruff lint (SOFT)
        run: |
          python -m ruff check . || true
      - name: MyPy (SOFT)
        run: |
          python -m pip install mypy || true
          mypy . || true
      - name: Bandit (SOFT)
        run: |
          python -m pip install bandit || true
          bandit -q -r aiculture || true
      - name: Detect Secrets (SOFT)
        run: |
          python -m pip install detect-secrets || true
          detect-secrets scan || true
