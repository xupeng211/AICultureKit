name: 📚 Deploy Documentation

on:
  push:
    branches: [ main ]
    paths:
      - 'docs/**'
      - 'README.md'
      - '.github/workflows/docs.yml'
  pull_request:
    branches: [ main ]
    paths:
      - 'docs/**'
      - 'README.md'

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
    - name: 📥 Checkout
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: 🐍 Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: 📦 Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install mkdocs mkdocs-material mkdocs-mermaid2-plugin

    - name: 🏗️ Build documentation
      run: |
        # 创建docs目录结构（如果不存在）
        mkdir -p docs
        
        # 复制README作为首页
        cp README.md docs/index.md
        
        # 创建基本的mkdocs配置
        cat > mkdocs.yml << EOF
        site_name: AICultureKit Documentation
        site_description: 企业级AI主导开发文化标准化工具包
        site_url: https://xupeng211.github.io/AICultureKit/
        repo_url: https://github.com/xupeng211/AICultureKit
        repo_name: xupeng211/AICultureKit
        
        theme:
          name: material
          palette:
            - scheme: default
              primary: blue
              accent: blue
              toggle:
                icon: material/brightness-7
                name: Switch to dark mode
            - scheme: slate
              primary: blue
              accent: blue
              toggle:
                icon: material/brightness-4
                name: Switch to light mode
          features:
            - navigation.tabs
            - navigation.sections
            - navigation.expand
            - navigation.top
            - search.highlight
            - content.code.copy
        
        nav:
          - 首页: index.md
          - 快速开始: getting-started.md
          - API参考: api-reference.md
          - 最佳实践: best-practices.md
          - 贡献指南: contributing.md
        
        plugins:
          - search
          - mermaid2
        
        markdown_extensions:
          - admonition
          - codehilite
          - pymdownx.superfences:
              custom_fences:
                - name: mermaid
                  class: mermaid
                  format: !!python/name:mermaid2.fence_mermaid
        EOF
        
        # 创建其他文档页面
        cp docs/API_REFERENCE.md docs/api-reference.md 2>/dev/null || echo "# API参考\n\n正在完善中..." > docs/api-reference.md
        cp docs/BEST_PRACTICES_GUIDE.md docs/best-practices.md 2>/dev/null || echo "# 最佳实践\n\n正在完善中..." > docs/best-practices.md
        cp CONTRIBUTING.md docs/contributing.md 2>/dev/null || echo "# 贡献指南\n\n正在完善中..." > docs/contributing.md
        
        # 创建快速开始页面
        cat > docs/getting-started.md << EOF
        # 🚀 快速开始
        
        ## 安装
        
        \`\`\`bash
        pip install aiculture-kit
        \`\`\`
        
        ## 创建第一个项目
        
        \`\`\`bash
        aiculture create my-project
        cd my-project
        \`\`\`
        
        ## 运行质量检查
        
        \`\`\`bash
        aiculture check
        \`\`\`
        
        更多详细信息请参考 [API参考](api-reference.md)。
        EOF
        
        # 构建文档
        mkdocs build

    - name: 📤 Upload artifact
      uses: actions/upload-pages-artifact@v2
      with:
        path: ./site

  deploy:
    if: github.ref == 'refs/heads/main'
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: 🚀 Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v2
