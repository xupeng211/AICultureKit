# AICultureKit Gitee Go Pipeline
# æŠŠ"çœŸæ­£é˜»å¡"æ”¾åœ¨PRåˆå¹¶é˜¶æ®µï¼›æ¨é€ä¸é˜»å¡

name: AICultureKit Gate
on:
  pull_request:
    branches: [ main, master ]
  push:
    branches: [ main, master ]

stages:
  - setup
  - lint
  - test
  - coverage
  - security
  - report

# ç¯å¢ƒå˜é‡
variables:
  PYTHON_VERSION: "3.11"
  PIP_CACHE_DIR: ".pip-cache"

# åŸºç¡€è®¾ç½®é˜¶æ®µ
setup:
  stage: setup
  image: python:3.11-slim
  cache:
    paths:
      - .pip-cache/
      - .pytest_cache/
  before_script:
    - apt-get update && apt-get install -y git
    - python -m pip install --upgrade pip
  script:
    - echo "ğŸš€ AICultureKit CI Gate å¯åŠ¨"
    - echo "Pythonç‰ˆæœ¬:" && python --version
    - echo "Gitç‰ˆæœ¬:" && git --version
    - echo "åˆ†æ”¯ä¿¡æ¯:" && git branch -a
    - echo "æäº¤ä¿¡æ¯:" && git log --oneline -5
    - pip install -r requirements.txt || echo "requirements.txtä¸å­˜åœ¨ï¼Œè·³è¿‡"
    - pip install pre-commit diff-cover coverage pytest ruff black isort bandit detect-secrets pytest-cov
    - echo "âœ… ç¯å¢ƒè®¾ç½®å®Œæˆ"
  artifacts:
    paths:
      - .pip-cache/
    expire_in: 1 hour

# ä»£ç é£æ ¼å’Œè´¨é‡æ£€æŸ¥
lint:
  stage: lint
  image: python:3.11-slim
  dependencies:
    - setup
  script:
    - echo "ğŸ“ è¿è¡Œä»£ç é£æ ¼æ£€æŸ¥..."
    - pip install ruff black isort
    - echo "ğŸ” Ruffæ£€æŸ¥..."
    - python -m ruff check . --output-format=json > artifacts/ruff_report.json || true
    - python -m ruff check . || echo "âš ï¸ Ruffå‘ç°é—®é¢˜ï¼Œä½†ä¸é˜»å¡CI"
    - echo "ğŸ¨ Blackæ ¼å¼æ£€æŸ¥..."
    - python -m black --check --diff . || echo "âš ï¸ Blackå‘ç°æ ¼å¼é—®é¢˜ï¼Œä½†ä¸é˜»å¡CI"
    - echo "ğŸ“¦ isortå¯¼å…¥æ£€æŸ¥..."
    - python -m isort --check-only --diff . || echo "âš ï¸ isortå‘ç°é—®é¢˜ï¼Œä½†ä¸é˜»å¡CI"
    - echo "âœ… ä»£ç é£æ ¼æ£€æŸ¥å®Œæˆ"
  artifacts:
    paths:
      - artifacts/ruff_report.json
    expire_in: 1 day
  allow_failure: true  # ä¸é˜»å¡åç»­é˜¶æ®µ

# æµ‹è¯•æ‰§è¡Œ
test:
  stage: test
  image: python:3.11-slim
  dependencies:
    - setup
  script:
    - echo "ğŸ§ª è¿è¡Œæµ‹è¯•å¥—ä»¶..."
    - pip install pytest pytest-cov
    - echo "ğŸ“Š æ‰§è¡Œæµ‹è¯•å¹¶ç”Ÿæˆè¦†ç›–ç‡æŠ¥å‘Š..."
    - pytest -q --maxfail=5 --disable-warnings --tb=short || echo "âš ï¸ éƒ¨åˆ†æµ‹è¯•å¤±è´¥ï¼Œä½†ç»§ç»­æ‰§è¡Œ"
    - pytest -q --maxfail=1 --disable-warnings --cov=aiculture --cov=tools --cov-report=xml:coverage.xml --cov-report=term-missing || echo "âš ï¸ è¦†ç›–ç‡æµ‹è¯•å¤±è´¥"
    - echo "âœ… æµ‹è¯•æ‰§è¡Œå®Œæˆ"
  artifacts:
    paths:
      - coverage.xml
      - .coverage
    expire_in: 1 day
  allow_failure: true  # ä¸é˜»å¡åç»­é˜¶æ®µ

# å¢é‡è¦†ç›–ç‡æ£€æŸ¥
coverage:
  stage: coverage
  image: python:3.11-slim
  dependencies:
    - setup
    - test
  script:
    - echo "ğŸ“Š è¿è¡Œå¢é‡è¦†ç›–ç‡æ£€æŸ¥..."
    - pip install diff-cover coverage
    - echo "ğŸ¯ æ£€æŸ¥å˜æ›´è¡Œè¦†ç›–ç‡..."
    - |
      if [ -f "coverage.xml" ]; then
        echo "å‘ç°è¦†ç›–ç‡æŠ¥å‘Šï¼Œæ‰§è¡Œdiff-coveræ£€æŸ¥..."
        diff-cover coverage.xml --compare-branch=origin/main --fail-under=80 --json-report=artifacts/diff_coverage.json || echo "âš ï¸ å¢é‡è¦†ç›–ç‡ä¸è¾¾æ ‡"
        diff-cover coverage.xml --compare-branch=origin/main --html-report=artifacts/diff_coverage.html || true
        echo "ğŸ“‹ è¦†ç›–ç‡æŠ¥å‘Šå·²ç”Ÿæˆ"
      else
        echo "âš ï¸ æœªæ‰¾åˆ°è¦†ç›–ç‡æŠ¥å‘Šï¼Œè·³è¿‡å¢é‡è¦†ç›–ç‡æ£€æŸ¥"
      fi
    - echo "âœ… å¢é‡è¦†ç›–ç‡æ£€æŸ¥å®Œæˆ"
  artifacts:
    paths:
      - artifacts/diff_coverage.json
      - artifacts/diff_coverage.html
    expire_in: 1 day
  allow_failure: true  # ä¸é˜»å¡åç»­é˜¶æ®µ

# å®‰å…¨æ£€æŸ¥
security:
  stage: security
  image: python:3.11-slim
  dependencies:
    - setup
  script:
    - echo "ğŸ”’ è¿è¡Œå®‰å…¨æ£€æŸ¥..."
    - pip install bandit detect-secrets
    - echo "ğŸ›¡ï¸ Banditå®‰å…¨æ‰«æ..."
    - bandit -r . -f json -o artifacts/bandit_report.json || echo "âš ï¸ Banditå‘ç°å®‰å…¨é—®é¢˜"
    - bandit -r . || echo "âš ï¸ å®‰å…¨æ£€æŸ¥å‘ç°é—®é¢˜ï¼Œä½†ä¸é˜»å¡CI"
    - echo "ğŸ”‘ å¯†é’¥æ³„æ¼æ£€æŸ¥..."
    - detect-secrets scan --all-files --baseline .secrets.baseline || echo "âš ï¸ å‘ç°æ½œåœ¨å¯†é’¥æ³„æ¼"
    - echo "âœ… å®‰å…¨æ£€æŸ¥å®Œæˆ"
  artifacts:
    paths:
      - artifacts/bandit_report.json
      - artifacts/secrets.baseline
    expire_in: 1 day
  allow_failure: true  # ä¸é˜»å¡åç»­é˜¶æ®µ

# ç”Ÿæˆç»¼åˆæŠ¥å‘Š
report:
  stage: report
  image: python:3.11-slim
  dependencies:
    - setup
    - lint
    - test
    - coverage
    - security
  script:
    - echo "ğŸ“‹ ç”ŸæˆAICultureKitç»¼åˆè´¨é‡æŠ¥å‘Š..."
    - mkdir -p artifacts
    - |
      # è¿è¡Œé—®é¢˜èšåˆå™¨ç”Ÿæˆå®Œæ•´æŠ¥å‘Š
      if [ -d "tools/problem_aggregator" ]; then
        echo "ğŸ” è¿è¡ŒAICultureKité—®é¢˜èšåˆå™¨..."
        python -m tools.problem_aggregator.aggregator --base origin/main --out artifacts/ci_problems.json --md artifacts/ci_problems_report.md || echo "âš ï¸ é—®é¢˜èšåˆå™¨æ‰§è¡Œå¤±è´¥"

        # å¦‚æœæœ‰é˜»å¡æ€§é—®é¢˜ï¼Œå°è¯•ç”ŸæˆAIä¿®å¤å»ºè®®
        if [ -f "artifacts/ci_problems.json" ]; then
          echo "ğŸ¤– å°è¯•ç”ŸæˆAIä¿®å¤å»ºè®®..."
          python -m tools.ai_fix_agent.agent --in artifacts/ci_problems.json --out artifacts/ai_fixes || echo "âš ï¸ AIä¿®å¤å»ºè®®ç”Ÿæˆå¤±è´¥"
        fi
      else
        echo "âš ï¸ æœªæ‰¾åˆ°é—®é¢˜èšåˆå™¨ï¼Œè·³è¿‡"
      fi
    - |
      # ç”ŸæˆCIæ‘˜è¦æŠ¥å‘Š
      echo "# ğŸ” AICultureKit CI Gate æŠ¥å‘Š" > artifacts/ci_summary.md
      echo "" >> artifacts/ci_summary.md
      echo "**æ„å»ºæ—¶é—´**: $(date)" >> artifacts/ci_summary.md
      echo "**åˆ†æ”¯**: $CI_COMMIT_REF_NAME" >> artifacts/ci_summary.md
      echo "**æäº¤**: $CI_COMMIT_SHA" >> artifacts/ci_summary.md
      echo "" >> artifacts/ci_summary.md
      echo "## ğŸ“Š æ£€æŸ¥ç»“æœ" >> artifacts/ci_summary.md
      echo "" >> artifacts/ci_summary.md

      # æ£€æŸ¥å„é˜¶æ®µç»“æœ
      echo "- **ä»£ç é£æ ¼**: $([ -f artifacts/ruff_report.json ] && echo 'âœ… å·²æ£€æŸ¥' || echo 'âŒ æœªæ‰§è¡Œ')" >> artifacts/ci_summary.md
      echo "- **æµ‹è¯•æ‰§è¡Œ**: $([ -f coverage.xml ] && echo 'âœ… å·²æ‰§è¡Œ' || echo 'âŒ æœªæ‰§è¡Œ')" >> artifacts/ci_summary.md
      echo "- **å¢é‡è¦†ç›–ç‡**: $([ -f artifacts/diff_coverage.json ] && echo 'âœ… å·²æ£€æŸ¥' || echo 'âŒ æœªæ‰§è¡Œ')" >> artifacts/ci_summary.md
      echo "- **å®‰å…¨æ£€æŸ¥**: $([ -f artifacts/bandit_report.json ] && echo 'âœ… å·²æ£€æŸ¥' || echo 'âŒ æœªæ‰§è¡Œ')" >> artifacts/ci_summary.md
      echo "- **é—®é¢˜èšåˆ**: $([ -f artifacts/ci_problems.json ] && echo 'âœ… å·²ç”Ÿæˆ' || echo 'âŒ æœªç”Ÿæˆ')" >> artifacts/ci_summary.md
      echo "" >> artifacts/ci_summary.md

      # æ·»åŠ ä¸‹ä¸€æ­¥å»ºè®®
      echo "## ğŸš€ ä¸‹ä¸€æ­¥å»ºè®®" >> artifacts/ci_summary.md
      echo "" >> artifacts/ci_summary.md
      echo "1. æŸ¥çœ‹è¯¦ç»†æŠ¥å‘Š: \`artifacts/ci_problems_report.md\`" >> artifacts/ci_summary.md
      echo "2. åº”ç”¨AIä¿®å¤: \`cd artifacts/ai_fixes && ./apply_fixes.sh\`" >> artifacts/ci_summary.md
      echo "3. æœ¬åœ°éªŒè¯: \`python -m tools.problem_aggregator.aggregator\`" >> artifacts/ci_summary.md
      echo "4. é‡æ–°æ¨é€éªŒè¯ä¿®å¤æ•ˆæœ" >> artifacts/ci_summary.md

      echo "ğŸ“‹ CIæ‘˜è¦æŠ¥å‘Šå·²ç”Ÿæˆ"
    - echo "âœ… ç»¼åˆæŠ¥å‘Šç”Ÿæˆå®Œæˆ"
  artifacts:
    paths:
      - artifacts/
    expire_in: 7 days
  allow_failure: false  # æŠ¥å‘Šç”Ÿæˆå¤±è´¥åˆ™æ•´ä¸ªCIå¤±è´¥

# æœ€ç»ˆå†³ç­–é˜¶æ®µï¼ˆä»…åœ¨PRæ—¶æ‰§è¡Œï¼‰
gate_decision:
  stage: report
  image: python:3.11-slim
  dependencies:
    - report
  script:
    - echo "ğŸšª AICultureKit Gate æœ€ç»ˆå†³ç­–..."
    - |
      # æ£€æŸ¥æ˜¯å¦æœ‰é˜»å¡æ€§é—®é¢˜
      BLOCKING_ISSUES=0

      if [ -f "artifacts/ci_problems.json" ]; then
        # ä½¿ç”¨Pythonè§£æJSONè·å–é˜»å¡æ€§é—®é¢˜æ•°é‡
        BLOCKING_ISSUES=$(python -c "
import json
try:
    with open('artifacts/ci_problems.json', 'r') as f:
        data = json.load(f)
    print(data.get('summary', {}).get('blocking', 0))
except:
    print(0)
" 2>/dev/null || echo 0)

        echo "å‘ç° $BLOCKING_ISSUES ä¸ªé˜»å¡æ€§é—®é¢˜"
      fi

      if [ "$BLOCKING_ISSUES" -gt 0 ]; then
        echo "âŒ PRåˆå¹¶è¢«é˜»å¡: å­˜åœ¨ $BLOCKING_ISSUES ä¸ªé˜»å¡æ€§é—®é¢˜"
        echo "ğŸ“‹ è¯¦ç»†æŠ¥å‘Š: artifacts/ci_problems_report.md"
        echo "ğŸ¤– AIä¿®å¤å»ºè®®: artifacts/ai_fixes/"
        echo ""
        echo "è¯·ä¿®å¤é˜»å¡æ€§é—®é¢˜åé‡æ–°æ¨é€"
        exit 1
      else
        echo "âœ… æ‰€æœ‰æ£€æŸ¥é€šè¿‡ï¼Œå…è®¸PRåˆå¹¶"
        exit 0
      fi
  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'  # ä»…åœ¨PRæ—¶æ‰§è¡Œ
  allow_failure: false  # é˜»å¡æ€§é—®é¢˜å¿…é¡»ä¿®å¤

# æ¸…ç†é˜¶æ®µ
cleanup:
  stage: report
  image: python:3.11-slim
  script:
    - echo "ğŸ§¹ æ¸…ç†ä¸´æ—¶æ–‡ä»¶..."
    - rm -rf .pytest_cache/ __pycache__/ *.pyc
    - echo "âœ… æ¸…ç†å®Œæˆ"
  when: always
  allow_failure: true
