#!/bin/bash
# AIè¡Œä¸ºå¼ºåˆ¶æ£€æŸ¥é’©å­
# ç¡®ä¿AIå·¥å…·éµå¾ªå¼€å‘æ–‡åŒ–æ ‡å‡†

set -e

# è¯»å–ç¯å¢ƒå˜é‡ï¼Œé»˜è®¤ä¸º 'warn'
ENFORCE_MODE=${AICULTURE_ENFORCE_BLOCKING:-warn}

# å¦‚æœè®¾ç½®ä¸º 'off'ï¼Œåˆ™å®Œå…¨è·³è¿‡
if [ "$ENFORCE_MODE" =[object Object]off)ï¼Œè·³è¿‡ã€‚"
    exit 0
fi

# å°†æ¨¡å¼ä¼ é€’ç»™Pythonè„šæœ¬
export AICULTURE_ENFORCE_BLOCKING=$ENFORCE_MODE


PYTHONPATH=. python -c "
import sys
import os

sys.path.insert(0, '.')

# ä»ç¯å¢ƒå˜é‡è·å–å¼ºåˆ¶æ¨¡å¼ï¼Œé»˜è®¤ä¸º 'warn'
enforce_mode = os.environ.get('AICULTURE_ENFORCE_BLOCKING', 'warn').lower()

print(f'ğŸ¤– æ‰§è¡ŒAIè¡Œä¸ºä¸æ–‡åŒ–æ ‡å‡†æ£€æŸ¥ (æ¨¡å¼: {enforce_mode})...')

exit_code = 0
error_messages = []

# --- æ£€æŸ¥1: AI è¡Œä¸ºå¼ºåˆ¶å™¨ ---
try:
    from aiculture.ai_behavior_enforcer import AIBehaviorEnforcer
    enforcer = AIBehaviorEnforcer('.')
    result = enforcer.enforce_ai_behavior()
    if result.get('violations_detected', 0) > 0:
        error_messages.append('ğŸš¨ AIè¡Œä¸ºè¿è§„æ£€æµ‹ï¼')
        error_messages.append(f'   è¿è§„æ•°é‡: {result[\"violations_detected\"]}')
        error_messages.append(f'   è¿è§„ç±»å‹: {result[\"violations\"]}')
        error_messages.append('   è§£å†³æ–¹æ¡ˆï¼šä¸è¦ç¦ç”¨æˆ–ç»•è¿‡è´¨é‡æ£€æŸ¥ã€‚')
        exit_code = 1
    else:
        print('âœ… AIè¡Œä¸ºè§„èŒƒæ£€æŸ¥é€šè¿‡')
except ImportError:
    print('âš ï¸  AIè¡Œä¸ºæ£€æŸ¥æ¨¡å— (ai_behavior_enforcer) æœªæ‰¾åˆ°ï¼Œè·³è¿‡æ­¤é¡¹æ£€æŸ¥ã€‚')
except Exception as e:
    print(f'âš ï¸  AIè¡Œä¸ºæ£€æŸ¥æ‰§è¡Œå¤±è´¥: {e}')
    if enforce_mode == 'block':
        exit_code = 1

# --- æ£€æŸ¥2: æ–‡åŒ–æ ‡å‡†å¼ºåˆ¶å™¨ ---
print(\"\nğŸ” æ‰§è¡Œæ–‡åŒ–æ ‡å‡†æ£€æŸ¥...\")
try:
    from aiculture.culture_enforcer import CultureEnforcer
    enforcer = CultureEnforcer('.')
    result = enforcer.enforce_all()

    print(f'ğŸ“Š æ–‡åŒ–è´¨é‡è¯„åˆ†: {result.get(\"score\", 0)}/100')
    print(f'   âŒ é”™è¯¯: {result.get(\"errors\", 0)} ä¸ª')
    print(f'   âš ï¸  è­¦å‘Š: {result.get(\"warnings\", 0)} ä¸ª')

    if result.get('errors', 0) > 0:
        error_messages.append('\\nğŸ›‘ æ–‡åŒ–æ ‡å‡†æ£€æŸ¥å‘ç°é˜»å¡æ€§é”™è¯¯:')
        error_messages.append('   è§£å†³æ–¹æ¡ˆ: è¯·æ ¹æ®ä¸Šæ–¹è¾“å‡ºä¿®å¤æ‰€æœ‰é”™è¯¯ã€‚')
        exit_code = 1
    elif result.get('score', 0) < 70:
        print('   - è­¦å‘Šï¼šæ–‡åŒ–è´¨é‡è¯„åˆ†è¾ƒä½ï¼Œå»ºè®®æ”¹è¿›ã€‚')
    else:
        print('âœ… æ–‡åŒ–æ ‡å‡†æ£€æŸ¥é€šè¿‡')

except ImportError:
    error_messages.append('âŒ æ–‡åŒ–æ£€æŸ¥æ¨¡å— (culture_enforcer) æœªæ‰¾åˆ°ï¼Œæ£€æŸ¥å¤±è´¥ã€‚')
    exit_code = 1
except Exception as e:
    error_messages.append(f'âŒ æ–‡åŒ–æ£€æŸ¥æ‰§è¡Œæ—¶å‘ç”Ÿæ„å¤–é”™è¯¯: {e}')
    exit_code = 1

# --- æœ€ç»ˆå†³ç­– ---
if exit_code != 0:
    print(\"\n\" + \"\n\".join(error_messages))
    if enforce_mode == 'block':
        print('\\nğŸ›‘ æäº¤è¢«é˜»æ­¢ (æ¨¡å¼: block)ã€‚è¯·ä¿®å¤æ‰€æœ‰é”™è¯¯åé‡è¯•ã€‚')
        sys.exit(1)
    else: # é»˜è®¤ 'warn' æ¨¡å¼
        print('\\nâš ï¸  æ£€æµ‹åˆ°é—®é¢˜ï¼Œä½†ç”±äºæ¨¡å¼ä¸º \'warn\'ï¼Œä»…å‘å‡ºè­¦å‘Šï¼Œä¸é˜»æ­¢æäº¤ã€‚')
        sys.exit(0)
else:
    print(\"\nâœ… æ‰€æœ‰æ£€æŸ¥é€šè¿‡ï¼Œå…è®¸æäº¤ã€‚\")
    sys.exit(0)
"

# æ•è·Pythonè„šæœ¬çš„é€€å‡ºç 
exit_code=$?

# æ ¹æ®é€€å‡ºç å†³å®šæ•´ä¸ªé’©å­çš„è¡Œä¸º
exit $exit_code
