#!/bin/bash

# AICultureKit æ™ºèƒ½æ¨é€å‰æ£€æŸ¥é’©å­
# åœ¨æ¨é€åˆ°è¿œç¨‹ä»“åº“å‰è¿›è¡Œæœ€ç»ˆçš„è´¨é‡ä¿éšœæ£€æŸ¥

# é¢œè‰²å®šä¹‰
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

echo -e "${BLUE}ğŸš€ æ‰§è¡Œæ¨é€å‰è´¨é‡æ£€æŸ¥...${NC}"

# æ£€æŸ¥æ˜¯å¦æœ‰æœªæäº¤çš„æ›´æ”¹
if ! git diff-index --quiet HEAD --; then
    echo -e "${RED}âŒ æ£€æµ‹åˆ°æœªæäº¤çš„æ›´æ”¹ï¼Œè¯·å…ˆæäº¤æ‰€æœ‰æ›´æ”¹${NC}"
    exit 1
fi

# è¿è¡Œå¿«é€Ÿè¯­æ³•æ£€æŸ¥ (compile-only)
echo -e "${BLUE}ğŸ§ª è¿è¡Œå¿«é€Ÿè¯­æ³•æ£€æŸ¥...${NC}"
if ! python -c "import compileall, sys; ok = compileall.compile_dir('aiculture', force=True, quiet=1); sys.exit(0 if ok else 1)"; then
    echo -e "${RED}âŒ è¯­æ³•æ£€æŸ¥å¤±è´¥ï¼Œæ¨é€è¢«é˜»æ­¢${NC}"
    echo -e "${YELLOW}ğŸ’¡ è¯·ä¿®å¤è¯­æ³•é”™è¯¯åå†æ¨é€${NC}"
    exit 1
fi

# è·³è¿‡ä»£ç è¦†ç›–ç‡æ£€æŸ¥ (é¿å…è¿è¡Œå®Œæ•´æµ‹è¯•)
echo -e "${BLUE}ğŸ“Š è·³è¿‡ä»£ç è¦†ç›–ç‡æ£€æŸ¥ (Quick Checkæ¨¡å¼)...${NC}"
coverage_result="N/A"

echo -e "${YELLOW}ğŸ’¡ å®Œæ•´çš„æµ‹è¯•å’Œè¦†ç›–ç‡æ£€æŸ¥å°†åœ¨GitHub Actionsçš„Quality Gateä¸­æ‰§è¡Œ${NC}"

# æ£€æŸ¥æ˜¯å¦æœ‰å¤§æ–‡ä»¶
echo -e "${BLUE}ğŸ“ æ£€æŸ¥å¤§æ–‡ä»¶...${NC}"
large_files=$(find . -type f -size +1M -not -path "./.git/*" -not -path "./.*env/*" -not -path "./venv/*")
if [[ -n "$large_files" ]]; then
    echo -e "${YELLOW}âš ï¸  å‘ç°å¤§æ–‡ä»¶:${NC}"
    echo "$large_files"
    echo -e "${YELLOW}ğŸ’¡ è€ƒè™‘ä½¿ç”¨Git LFSç®¡ç†å¤§æ–‡ä»¶${NC}"
fi

# æ£€æŸ¥æ•æ„Ÿä¿¡æ¯
echo -e "${BLUE}ğŸ”’ æ£€æŸ¥æ•æ„Ÿä¿¡æ¯...${NC}"
sensitive_patterns=("password" "secret" "token" "api_key" "private_key")
for pattern in "${sensitive_patterns[@]}"; do
    if git log --oneline -n 10 | xargs git show | grep -i "$pattern" > /dev/null; then
        echo -e "${YELLOW}âš ï¸  å¯èƒ½åŒ…å«æ•æ„Ÿä¿¡æ¯: $pattern${NC}"
        echo -e "${YELLOW}ğŸ’¡ è¯·ç¡®è®¤æ˜¯å¦éœ€è¦ç§»é™¤æ•æ„Ÿä¿¡æ¯${NC}"
    fi
done

# ç”Ÿæˆæ¨é€æŠ¥å‘Š
echo -e "${BLUE}ğŸ“‹ ç”Ÿæˆæ¨é€æŠ¥å‘Š...${NC}"
commit_count=$(git rev-list --count HEAD ^origin/$(git branch --show-current) 2>/dev/null || echo "0")
changed_files=$(git diff --name-only HEAD~${commit_count}..HEAD 2>/dev/null | wc -l)

echo -e "${GREEN}âœ… æ¨é€å‰æ£€æŸ¥å®Œæˆ${NC}"
echo -e "${BLUE}ğŸ“Š æ¨é€ç»Ÿè®¡:${NC}"
echo -e "   - æ–°æäº¤æ•°: $commit_count"
echo -e "   - ä¿®æ”¹æ–‡ä»¶æ•°: $changed_files"
echo -e "   - ä»£ç è¦†ç›–ç‡: ${coverage_result}"
echo -e "   - æ¨é€æ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')"

# è¯¢é—®æ˜¯å¦ç»§ç»­æ¨é€ï¼ˆå¯é€‰ï¼‰
if [[ "$1" == "--interactive" ]]; then
    echo -e "${YELLOW}æ˜¯å¦ç»§ç»­æ¨é€? (y/N)${NC}"
    read -r response
    if [[ ! "$response" =~ ^[Yy]$ ]]; then
        echo -e "${YELLOW}æ¨é€å·²å–æ¶ˆ${NC}"
        exit 1
    fi
fi

echo -e "${GREEN}ğŸš€ è´¨é‡æ£€æŸ¥é€šè¿‡ï¼Œå…è®¸æ¨é€${NC}"
exit 0
