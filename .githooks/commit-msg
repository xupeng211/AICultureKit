#!/bin/bash

# AICultureKit 智能提交信息检查钩子
# 自动规范化提交信息，确保符合开发文化标准

commit_file="$1"
commit_msg=$(cat "$commit_file")

# 颜色定义
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

# 检查提交信息是否符合规范
check_commit_format() {
    local msg="$1"

    # 跳过merge提交
    if [[ $msg =~ ^Merge ]]; then
        return 0
    fi

    # 检查是否有emoji和类型标识
    if [[ $msg =~ ^(✨|🐛|📚|🎨|♻️|⚡|🧪|🔧|🚀|🔒)[[:space:]]+(feat|fix|docs|style|refactor|perf|test|chore|deploy|security): ]]; then
        return 0
    fi

    return 1
}

# 自动修复提交信息
auto_fix_commit() {
    local msg="$1"

    # 如果是简单的描述，尝试自动添加类型
    if [[ $msg =~ ^(add|添加|新增) ]]; then
        echo "✨ feat: $msg"
    elif [[ $msg =~ ^(fix|修复|解决) ]]; then
        echo "🐛 fix: $msg"
    elif [[ $msg =~ ^(update|更新|修改) ]]; then
        echo "♻️ refactor: $msg"
    elif [[ $msg =~ ^(test|测试) ]]; then
        echo "🧪 test: $msg"
    elif [[ $msg =~ ^(doc|文档) ]]; then
        echo "📚 docs: $msg"
    else
        # 默认为功能更新
        echo "✨ feat: $msg"
    fi
}

# 主逻辑
if ! check_commit_format "$commit_msg"; then
    echo -e "${YELLOW}📝 提交信息不符合规范，正在自动修复...${NC}"

    # 获取第一行（标题）
    title=$(echo "$commit_msg" | head -n1)

    # 自动修复
    fixed_msg=$(auto_fix_commit "$title")

    # 保留原始的详细描述（如果有）
    body=$(echo "$commit_msg" | tail -n +2)

    # 生成新的提交信息
    if [[ -n "$body" && "$body" != "$title" ]]; then
        echo -e "$fixed_msg\n$body" > "$commit_file"
    else
        echo "$fixed_msg" > "$commit_file"
    fi

    echo -e "${GREEN}✅ 提交信息已自动规范化: $fixed_msg${NC}"
fi

# 检查提交信息长度
title_length=$(echo "$commit_msg" | head -n1 | wc -c)
if [ "$title_length" -gt 72 ]; then
    echo -e "${YELLOW}⚠️  提交标题过长 ($title_length 字符)，建议控制在50字符内${NC}"
fi

# 添加自动生成的元信息
echo "" >> "$commit_file"
echo "# 📊 自动生成的提交统计:" >> "$commit_file"
echo "# - 修改文件数: $(git diff --cached --name-only | wc -l)" >> "$commit_file"
echo "# - 代码行数变化: +$(git diff --cached --numstat | awk '{add+=$1} END {print add+0}') -$(git diff --cached --numstat | awk '{del+=$2} END {print del+0}')" >> "$commit_file"
echo "# - 提交时间: $(date '+%Y-%m-%d %H:%M:%S')" >> "$commit_file"

exit 0
