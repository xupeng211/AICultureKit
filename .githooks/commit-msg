#!/bin/bash

# AICultureKit æ™ºèƒ½æäº¤ä¿¡æ¯æ£€æŸ¥é’©å­
# è‡ªåŠ¨è§„èŒƒåŒ–æäº¤ä¿¡æ¯ï¼Œç¡®ä¿ç¬¦åˆå¼€å‘æ–‡åŒ–æ ‡å‡†

commit_file="$1"
commit_msg=$(cat "$commit_file")

# é¢œè‰²å®šä¹‰
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

# æ£€æŸ¥æäº¤ä¿¡æ¯æ˜¯å¦ç¬¦åˆè§„èŒƒ
check_commit_format() {
    local msg="$1"

    # è·³è¿‡mergeæäº¤
    if [[ $msg =~ ^Merge ]]; then
        return 0
    fi

    # æ£€æŸ¥æ˜¯å¦æœ‰emojiå’Œç±»åž‹æ ‡è¯†
    if [[ $msg =~ ^(âœ¨|ðŸ›|ðŸ“š|ðŸŽ¨|â™»ï¸|âš¡|ðŸ§ª|ðŸ”§|ðŸš€|ðŸ”’)[[:space:]]+(feat|fix|docs|style|refactor|perf|test|chore|deploy|security): ]]; then
        return 0
    fi

    return 1
}

# è‡ªåŠ¨ä¿®å¤æäº¤ä¿¡æ¯
auto_fix_commit() {
    local msg="$1"

    # å¦‚æžœæ˜¯ç®€å•çš„æè¿°ï¼Œå°è¯•è‡ªåŠ¨æ·»åŠ ç±»åž‹
    if [[ $msg =~ ^(add|æ·»åŠ |æ–°å¢ž) ]]; then
        echo "âœ¨ feat: $msg"
    elif [[ $msg =~ ^(fix|ä¿®å¤|è§£å†³) ]]; then
        echo "ðŸ› fix: $msg"
    elif [[ $msg =~ ^(update|æ›´æ–°|ä¿®æ”¹) ]]; then
        echo "â™»ï¸ refactor: $msg"
    elif [[ $msg =~ ^(test|æµ‹è¯•) ]]; then
        echo "ðŸ§ª test: $msg"
    elif [[ $msg =~ ^(doc|æ–‡æ¡£) ]]; then
        echo "ðŸ“š docs: $msg"
    else
        # é»˜è®¤ä¸ºåŠŸèƒ½æ›´æ–°
        echo "âœ¨ feat: $msg"
    fi
}

# ä¸»é€»è¾‘
if ! check_commit_format "$commit_msg"; then
    echo -e "${YELLOW}ðŸ“ æäº¤ä¿¡æ¯ä¸ç¬¦åˆè§„èŒƒï¼Œæ­£åœ¨è‡ªåŠ¨ä¿®å¤...${NC}"

    # èŽ·å–ç¬¬ä¸€è¡Œï¼ˆæ ‡é¢˜ï¼‰
    title=$(echo "$commit_msg" | head -n1)

    # è‡ªåŠ¨ä¿®å¤
    fixed_msg=$(auto_fix_commit "$title")

    # ä¿ç•™åŽŸå§‹çš„è¯¦ç»†æè¿°ï¼ˆå¦‚æžœæœ‰ï¼‰
    body=$(echo "$commit_msg" | tail -n +2)

    # ç”Ÿæˆæ–°çš„æäº¤ä¿¡æ¯
    if [[ -n "$body" && "$body" != "$title" ]]; then
        echo -e "$fixed_msg\n$body" > "$commit_file"
    else
        echo "$fixed_msg" > "$commit_file"
    fi

    echo -e "${GREEN}âœ… æäº¤ä¿¡æ¯å·²è‡ªåŠ¨è§„èŒƒåŒ–: $fixed_msg${NC}"
fi

# æ£€æŸ¥æäº¤ä¿¡æ¯é•¿åº¦
title_length=$(echo "$commit_msg" | head -n1 | wc -c)
if [ "$title_length" -gt 72 ]; then
    echo -e "${YELLOW}âš ï¸  æäº¤æ ‡é¢˜è¿‡é•¿ ($title_length å­—ç¬¦)ï¼Œå»ºè®®æŽ§åˆ¶åœ¨50å­—ç¬¦å†…${NC}"
fi

# æ·»åŠ è‡ªåŠ¨ç”Ÿæˆçš„å…ƒä¿¡æ¯
echo "" >> "$commit_file"
echo "# ðŸ“Š è‡ªåŠ¨ç”Ÿæˆçš„æäº¤ç»Ÿè®¡:" >> "$commit_file"
echo "# - ä¿®æ”¹æ–‡ä»¶æ•°: $(git diff --cached --name-only | wc -l)" >> "$commit_file"
echo "# - ä»£ç è¡Œæ•°å˜åŒ–: +$(git diff --cached --numstat | awk '{add+=$1} END {print add+0}') -$(git diff --cached --numstat | awk '{del+=$2} END {print del+0}')" >> "$commit_file"
echo "# - æäº¤æ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')" >> "$commit_file"

exit 0
